Malware Analysis has always been one of my favourite cybersecurity topics, so in 2016, I bought a book called "Practical Malware Analysis: The Hands-On Guide to Dissecting Malicious Software". I looked through it for a bit, then I got busy, and it ended up sitting on the shelf for years. But having finished uni recently, I've had a lot of spare time between looking for a job. I figured this would be the perfect chance to pick up that book again and finally go through it and improve my malware analysis skills a bit.

Since 2016 I've come a long way with all of my cybersecurity skills and knowledge, so I've gained some malware analysis experience from other sources - btw shoutout to [hasherezade](https://twitter.com/hasherezade) for being an inspiration in the community and for providing so much great advice when I DM'd her asking where to start (although I'm sure she doesn't really need the shoutout) - but I think chapter one is still a good place to start as it will serve as a good refresh for me and who knows maybe I'll still learn some small tips. However, I am still quite new to malware analysis so if you notice any errors in this blog please send me a message on twitter and let me know so I can correct them and learn more about the topic!

Okay, now that's all said, let's get on with the chapter one lab. This lab is split into four parts with 4-7 questions to answer. Each with the aim to help teach some basic malware analysis techniques so should hopefully be easy.

# Lab 1-1

![1-1 Questions](https://i.imgur.com/UDrhydD.png)

# Q1
Okay, so question one is simple, all I need to do is upload some files to VirusTotal and see if it comes up as malware. My malware analysis environment doesn't have network access, so I'm going to take a slightly different approach and get the file hashes and put them into virustotal on a device with network access. So I'll use a program called pestudio.

![pestudio](https://i.imgur.com/qjMrTuZ.png)

So we can see that the md5 signature for the dll file is "290934C61DE9176AD682FFDD65F0A669" and "BB7425b82141A1C0F7D60E5106676BB1" for the exe. When we put these into virustotal, we can see that they are known viruses - there's a lot more we can do with this, but this is all the question wants, so we'll leave it at that for now. 

![l1-1vt](https://i.imgur.com/4b5HbTb.png)

# Q2
Okay, now that we know this, let's go back to pestudio to answer question two - we can look at the compiler-stamp line to see that  both files were compiled on 19th December 2010 at 4:16pm.

# Q3
Question three asks if there is any indication that the files are packed. So to check if they are packed we'll look at peid where we'll see that the files are not packed.

![notpacked](https://i.imgur.com/RbxKqGF.png)

# Q4
Next, we'll look at the functions tab in pestudio. We're looking for any functions that indicate any actions the malware can perform. We can do a quick google search for each of these functions if we don't know what they do. The most interesting functions seem to be "FindNextFileA", "FindFirstFileA", "CreateFileA", "CopyFileA". From this, we know the malware can look for certain files to modify or create completely new files. The dll imports "CreateProcess," meaning it can start other programs.

![functionsl1-1](https://i.imgur.com/j6RpOgn.png)

# Q5
Now we'll look at question five. "Are there any other files or host-based indicators you could look for on infected files?" - Okay, so without dynamic analysis, it can be hard to know what files the malware might be using or creating, but we can find some hints by looking at the strings. You can run the "strings" command to do this, but I already have pestudio open, so I'll look in the strings tab and sort by hints.

![stringsl1-1](https://i.imgur.com/QUMk6aQ.png)

The first thing I notice is "kerne132.dll" this is really weird... It should be "kernel32.dll," so maybe the exe is creating a new dll called kerne132.dll and attempting to hide it while looking like the legitimate file. It's also possible that the malware is modifying kernel32.dll and then renaming it. We also see "Lab01-01.dll,"  which we know is the other file for this lab. 

# Q6
Moving on to question 6, we're looking for network indicators now. Again, the strings tool is great for this. There are no network indicators in the exe, so how about we look at the dll file this time.

![strings2l1-1](https://i.imgur.com/zJ0VO1q.png)

The only network indicator we can find here is an ip address "127.26.152.13".

# Q7

The final question for this section of the lab is to guess the purpose of the malware. That can be hard, but I might say that the exe is a malware dropper downloading the dll. As for the dll itself, it is likely a backdoor allowing the attacker to open, create and modify files or open any processes to run scripts or other malware etc.

# Lab 1-2
Moving on to the second section of the lab, we'll be using the "Lab1-2.exe" file for these questions.

![1-2 Questions](https://i.imgur.com/QeWfGGC.png)

# Q1

This question again asks us to look at VirusTotal for details on this file. We'll repeat the same process as we did for the previous files and find that it is again known malware. 

![l1-2VT](https://i.imgur.com/0OddDYK.png)

# Q2

Question two needs us to check if the file is packed, so let's open it in peid.

![l1-2peid](https://i.imgur.com/BHbYTTa.png)

And we can see it's packed with a packer called UPX. Let's unpack this.

UPX is super easy to unpack as the tool used to pack and unpack these files is available for free and very easy to use.

```
upx "C:\Users\MalAnalysis\Documents\Practical Malware Analysis Labs\BinaryCollection\Chapter_1L\Lab01-02.exe" -d -o "C:\Users\MalAnalysis\Documents\Practical Malware Analysis Labs\BinaryCollection\Chapter_1L\Lab1-2-Unpacked.exe" 
```
Using the command above, we can unpack the file to a new file called Lab1-2-Unpacked.exe. We'll be using this file for the rest of this lab section.

# Q3
So for question three, we're looking at the imports. We'll be trying to find some of the features of this malware. There are four groups that are interesting to me here. First, there's the wininet group which is two imports, "InternetOpen" and "InternetOpenUrl" these are used to establish a connection to a server outside the network - to either download a file or send commands from a C2 server. The second group that is interesting to me is the advapi32 group which is three imports "CreateService", "StartServiceCtrlDispatcher," and "OpenSCManager" all of these are service related and are probably there to establish persistence. Next is the thread group, importing "CreateThread" and "CreateMutex" these imports aren't suspicious, but they tell us that the malware is accessing the same resources with multiple threads. The final group is just one import, "ExitProcess" this, again, isn't too suspicious, but it could mean that the malware closes itself after performing its tasks.   

InternetOpen - Starts using WinINet library for internet connections.
InternetOpenUrl - Connects to a URL


OpenSCManager - Connects to the Service Control Manager
CreateService - persistence or to load kernel drivers
StartServiceCtrlDispatcher - can be used for persistence

CreateThread - This is common in programs and isn't suspicious at all, but at least it tells us that the malware is likely doing multiple tasks.
CreateMutex - Creates a mutex so multiple threads can access the same resources.


ExitProcess - This isn't too suspicious, but it shows that the program can close itself if needed. Either to avoid detection or after it has finished all of its tasks.

# Q4
Finally, let's look for some indicators to identify this malware. We'll look at the strings to do this. Immediately I see there's a url "https://www.malwareanalysisbook.com" this must be the url the malware is opening with the "InternetOpenUrl" import is a network indicator.

![l1-2strings1](https://i.imgur.com/XGccT44.png)

Now, if we scroll down a bit, we'll see "MalService" and "Malservice" these are probably the services that the malware uses for persistence. So we can use this service as a host-based indicator.

![l1-2strings2](https://i.imgur.com/B2gdysU.png)

# Lab 1-3

![1-3 Questions](https://i.imgur.com/T8Ho0b5.png)

Part three of this lab should be quick as it's asking the same questions as part two but for the "Lab01-03.exe" file.

# Q1

So first, we look on VirusTotal, and of course, it's known malware again, so no surprises there. Let's move on to question 2.

# Q2

For this, we'll look at peid again - and this one uses a packer called "FSG 1.0". So I'll google this and look at how it works and how to unpack it.
![l1-3peid](https://i.imgur.com/t23to8a.png)
It looks like this is an old packer, and it seems easy to unpack, but I'd have to use tools that the book hasn't even mentioned yet. So since I want to follow the book, I'll leave this for now. (After doing all the questions, I checked the answers, and it looks like the author expects you to get stuck on this one as the answer is "The file is packed, but we can't unpack it at this time").

# Q3
Unfortunately, without unpacking the file, there's not much we can do, so we'll leave it for later.

# Q4
Unfortunately, without unpacking the file, there's not much we can do, so we'll leave it for later.

# Lab 1-4

![1-4 Questions](https://i.imgur.com/cvccsJ7.png)

For the fourth and final part of this lab, we start the same by loading it into VirusTotal and repeating a few more of the previous questions, but the last question is new, so we'll be looking at the resources that the file uses.

# Q1 
We put the hash into VirusTotal, and by this point, we already know that it's a known virus - just as everything in this book will be.

# Q2
Let's load it into peid and see if it's packed. This time it doesn't find any packer, which is nice as it means we can continue without extra work.
![l1-4peid](https://i.imgur.com/SMurRDH.png)

# Q3
This one is interesting because if we look at the complier-stamp in pestudio, we'll see that it says it was compiled in 2019. However, this can't be true because the book was released before this date. But windows explorer says that the date modified is 05/07/2011, so perhaps this could be the compile date.

![l1-4compiled](https://i.imgur.com/zBfQUvx.png)

# Q4
There are a lot of interesting imports here, so I'm not going to go through them all in detail. Instead, I'll explain the possible functions and show which imports correspond to each of the functions.

![l1-4imports](https://i.imgur.com/cQcsRe4.png)

First, we can see that malware can modify or create files. Which is common for most programs but still worth knowing
- CreateFile
- MoveFile
- WriteFile

Next, we see that malware is opening a program
- WinExec
- OpenProcess

Then there are some imports indicating that the malware is doing something with user privileges
- OpenProcessToken
- LookupPrivilage
- AdjustTokenPrivilages

We also see that there are some imports relating to loading a resource
- LoadResource
- FindResource
- SizeofResource

Lastly, there are quite a few imports that could be for dll injection
- LoadLibrary
- CreateRemoteThread
- GetProcAddress
- GetModuleHandle
- CloseHandle

# Q5
Now we'll look at the strings again to find any indicators that will allow us to identify the malware.


![l1-4strings](https://i.imgur.com/pZdMvL9.jpg)

We immediately see "winlogon.exe". Which is the name of a process windows uses. However, there is also a chance that we can use this as an indicator, but for now, we can't tell if it is the legitimate file or not. Either way, it's worth noting that the malware is using this process.

Next, we see a network indicator - "http://www.practicalmalwareanalysis.com/updater.exe" - maybe this file is being downloaded?

Scrolling down more, we'll see some dll files "sfc_os.dll," "psapi.dll," and "urlmon.dll". My guess is that the malware is loading these libraries after compiling to conceal their use.

We can also see the file "\system32\wupdmgr.exe", the windows update manager. Perhaps the malware could be modifying this file.

Finally, there is a file called "winup.exe" this is likely disguising itself as the windows updater to avoid being found and should be used as an indicator to identify the malware.

# Q6
So in the final question of this lab, we'll use resource hacker to look at the resource that the malware uses.

Looking at this resource, we can look at the file header and tell that it's a pe file, so we'll go to the action option and save it as a binary file.

![resourcehacker](https://i.imgur.com/oposBMh.png)

Now let's look at this file in pestudio.

We see that the compile time is 27th Feb 2011, and then if we look at the imports, we'll notice "WinExec" and "URLDownloadToFile".

Now it's clear what is likely happening with this malware. It is modifying the "wupdmgr.exe" file. Then the resource file downloads the file from "http://www.practicalmalwareanalysis.com/updater.exe" and executes it. From here, we can't be sure what is happening without analysing updater.exe. But I'd imagine this is either a malware downloader/updater for the file "winup.exe" that we found referenced in "Lab-01-04.exe," or the other possibility is that "winup.exe" is not used by the malware at all and "updater.exe" is the malware trying to disguise itself as the windows updater.

# Conclusion
In this post, I did the chapter 1 labs in the practical malware analysis book, looking at some basic static malware analysis. I thought this was a really interesting lab for beginners, and I'm planning on going through the rest of the labs here on my blog. Chapter 2 doesn't have a lab, so next, I'll be doing the chapter 3 lab, which looks at basic dynamic analysis. Although I knew how to do most of the stuff in this lab already, it was still a great way to refresh myself, and I may have even made some mistakes, so if you notice any, please let me know! Thanks for reading.
